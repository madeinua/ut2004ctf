<html>
<head>

<script src="lib.js"></script>
<script src="games.js"></script>

<style type="text/css">
.tablesorter-blue{width:100%;background-color:#fff;margin:10px 0 15px;text-align:left;border-spacing:0;border:#cdcdcd 1px solid;border-width:1px 0 0 1px}.tablesorter-blue td,.tablesorter-blue th{border:#cdcdcd 1px solid;border-width:0 1px 1px 0}.tablesorter-blue th,.tablesorter-blue thead td{font:12px/18px Arial,Sans-serif;font-weight:700;color:#000;background-color:#99bfe6;border-collapse:collapse;padding:4px;text-shadow:0 1px 0 rgba(204,204,204,.7)}.tablesorter-blue tbody td,.tablesorter-blue tfoot td,.tablesorter-blue tfoot th{padding:4px;vertical-align:top}.tablesorter-blue .header,.tablesorter-blue .tablesorter-header{background-image:url(data:image/gif;base64,R0lGODlhFQAJAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAkAAAIXjI+AywnaYnhUMoqt3gZXPmVg94yJVQAAOw==);background-repeat:no-repeat;background-position:center right;padding:4px 18px 4px 4px;white-space:normal;cursor:pointer}.tablesorter-blue .headerSortUp,.tablesorter-blue .tablesorter-headerAsc,.tablesorter-blue .tablesorter-headerSortUp{background-color:#9fbfdf;background-image:url(data:image/gif;base64,R0lGODlhFQAEAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAQAAAINjI8Bya2wnINUMopZAQA7)}.tablesorter-blue .headerSortDown,.tablesorter-blue .tablesorter-headerDesc,.tablesorter-blue .tablesorter-headerSortDown{background-color:#8cb3d9;background-image:url(data:image/gif;base64,R0lGODlhFQAEAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAQAAAINjB+gC+jP2ptn0WskLQA7)}.tablesorter-blue thead .sorter-false{background-image:none;cursor:default;padding:4px}.tablesorter-blue tfoot .tablesorter-headerAsc,.tablesorter-blue tfoot .tablesorter-headerDesc,.tablesorter-blue tfoot .tablesorter-headerSortDown,.tablesorter-blue tfoot .tablesorter-headerSortUp{background-image:none}.tablesorter-blue td{color:#3d3d3d;background-color:#fff;padding:4px;vertical-align:top}.tablesorter-blue tbody>tr.even.hover>td,.tablesorter-blue tbody>tr.even:hover+tr.tablesorter-childRow+tr.tablesorter-childRow>td,.tablesorter-blue tbody>tr.even:hover+tr.tablesorter-childRow>td,.tablesorter-blue tbody>tr.even:hover>td,.tablesorter-blue tbody>tr.hover>td,.tablesorter-blue tbody>tr:hover+tr.tablesorter-childRow+tr.tablesorter-childRow>td,.tablesorter-blue tbody>tr:hover+tr.tablesorter-childRow>td,.tablesorter-blue tbody>tr:hover>td{background-color:#d9d9d9}.tablesorter-blue tbody>tr.odd.hover>td,.tablesorter-blue tbody>tr.odd:hover+tr.tablesorter-childRow+tr.tablesorter-childRow>td,.tablesorter-blue tbody>tr.odd:hover+tr.tablesorter-childRow>td,.tablesorter-blue tbody>tr.odd:hover>td{background-color:#bfbfbf}.tablesorter-blue .tablesorter-processing{background-position:center center!important;background-repeat:no-repeat!important;background-image:url(data:image/gif;base64,R0lGODlhFAAUAKEAAO7u7lpaWgAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQBCgACACwAAAAAFAAUAAACQZRvoIDtu1wLQUAlqKTVxqwhXIiBnDg6Y4eyx4lKW5XK7wrLeK3vbq8J2W4T4e1nMhpWrZCTt3xKZ8kgsggdJmUFACH5BAEKAAIALAcAAAALAAcAAAIUVB6ii7jajgCAuUmtovxtXnmdUAAAIfkEAQoAAgAsDQACAAcACwAAAhRUIpmHy/3gUVQAQO9NetuugCFWAAAh+QQBCgACACwNAAcABwALAAACE5QVcZjKbVo6ck2AF95m5/6BSwEAIfkEAQoAAgAsBwANAAsABwAAAhOUH3kr6QaAcSrGWe1VQl+mMUIBACH5BAEKAAIALAIADQALAAcAAAIUlICmh7ncTAgqijkruDiv7n2YUAAAIfkEAQoAAgAsAAAHAAcACwAAAhQUIGmHyedehIoqFXLKfPOAaZdWAAAh+QQFCgACACwAAAIABwALAAACFJQFcJiXb15zLYRl7cla8OtlGGgUADs=)!important}.tablesorter-blue tbody tr.odd>td{background-color:#ebf2fa}.tablesorter-blue tbody tr.even>td{background-color:#fff}.tablesorter-blue td.primary,.tablesorter-blue tr.odd td.primary{background-color:#99b3e6}.tablesorter-blue tr.even td.primary{background-color:#c2d1f0}.tablesorter-blue td.secondary,.tablesorter-blue tr.odd td.secondary{background-color:#c2d1f0}.tablesorter-blue tr.even td.secondary{background-color:#d6e0f5}.tablesorter-blue td.tertiary,.tablesorter-blue tr.odd td.tertiary{background-color:#d6e0f5}.tablesorter-blue tr.even td.tertiary{background-color:#ebf0fa}.tablesorter-blue>caption{background-color:#fff}.tablesorter-blue .tablesorter-filter-row{background-color:#eee}.tablesorter-blue .tablesorter-filter-row td{background-color:#eee;line-height:normal;text-align:center;-webkit-transition:line-height .1s ease;-moz-transition:line-height .1s ease;-o-transition:line-height .1s ease;transition:line-height .1s ease}.tablesorter-blue .tablesorter-filter-row .disabled{opacity:.5;cursor:not-allowed}.tablesorter-blue .tablesorter-filter-row.hideme td{padding:2px;margin:0;line-height:0;cursor:pointer}.tablesorter-blue .tablesorter-filter-row.hideme *{height:1px;min-height:0;border:0;padding:0;margin:0;opacity:0}.tablesorter-blue input.tablesorter-filter,.tablesorter-blue select.tablesorter-filter{width:98%;height:auto;margin:0;padding:4px;background-color:#fff;border:1px solid #bbb;color:#333;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;-webkit-transition:height .1s ease;-moz-transition:height .1s ease;-o-transition:height .1s ease;transition:height .1s ease}.tablesorter .filtered{display:none}.tablesorter .tablesorter-errorRow td{text-align:center;cursor:pointer;background-color:#e6bf99}
</style>

</head>
<body>

<div id="data"></div>

<script>

	function getPlayers() {
			
		var players = [];

		players['Gooz'] = 2000;
		players['Koffee'] = 2000;
		players['MVDE'] = 2000;
		players['mnt'] = 1900;
		players['simson'] = 1850;
		players['TT-Tolyan'] = 1750;
		players['ImitatoR'] = 1750;
		players['Maldito'] = 1650;
		players['chitrox'] = 1500;
		players['Hodor'] = 1500;
		players['Small'] = 1450;
		players['pr!x'] = 1450;
		players['viking'] = 1450;
		players['j'] = 1450;
		players['Rigel'] = 1450;
		players['Vernon'] = 1450;
		players['konstves'] = 1400;
		players['Sonic'] = 1400;
		players['raynn'] = 1400;
		players['pepper'] = 1400;
		players['Alter'] = 1400;
		players['Cold-M'] = 1400;
		players['Loox'] = 1400;
		players['Krnki'] = 1300;
		players['Keeper'] = 1300;
		players['oak'] = 1300;
		players['what'] = 1300;
		players['MoRoZ'] = 1300;
		players['RoMoLo'] = 1300;
		players['RM'] = 1250;
		players['ShX'] = 1250;
		players['Fridrih'] = 1150;
		players['Forsiets'] = 1100;
		players['mind'] = 1050;
		players['Lasunii'] = 1000;
		players['Swogu'] = 1000;
		players['Thoums'] = 900;
		players['Mistic'] = 900;
		players['brizzle'] = 900;
		players['zazuza'] = 700;
		players['rug:dude'] = 700;
		players['Bad_Bond'] = 700;
		players['hida'] = 700;
		players['Glister'] = 700;
		players['satanspy'] = 700;
		players['fortis_cor'] = 700;
		players['vozhyk'] = 300;
		
		return players;
	}
	
	var data = document.getElementById('data');
	
	data.innerHTML = 'Loading............';
	
    setTimeout(function() {
	
		var buff = '',
			players = getPlayers(),
			games = getGames();
			
		var getSortedKeys = function(obj) {
			
			var keys = Object.keys(obj);
			
			return keys.sort(function(a, b) {
				return obj[b] - obj[a];
			});
		};
		
		var getMaxInArray = function (arr, key) {
			
			var max = 0,
				val;
			
			for (var i in arr) {
			
				if (typeof key === 'undefined') {
					val = arr[i];
				} else {
					val = arr[i][key];
				}
			
				if (val > max) {
					max = val;
				}
			}
			
			return max;
		};
		
		var calculateTeamTotalElo = function(team) {

			var sum = 0;

			for (var k in team) {
				sum += players[team[k]];
			}

			return sum;
		};

		var isRedTeamPlayer = function(game, playerName) {

			for (var k in game.red) {
				if (game.red[k] === playerName) {
					return true;
				}
			}

			return false;
		};
		
		var isBlueTeamPlayer = function(game, playerName) {

			for (var k in game.blue) {
				if (game.blue[k] === playerName) {
					return true;
				}
			}

			return false;
		};
		
		var playedGames = [],
			darkHorses = [],
			playerMapStats = [],
			winRates = [],
			minDarkHorseDay = 30,
			minDarkHorseTs = Math.ceil((new Date().getTime()) - minDarkHorseDay * 60 * 60 * 24 * 1000),
			scores = [];
		
		for (i in players) {
		
			darkHorses[i] = 0;
			playedGames[i] = 0;
			
			playerMapStats[i] = { 
				wins: [], 
				played: [] 
			};
			
			winRates[i] = {
				wins: 0,
				loses: 0,
				avg: 0
			};
			
			scores[i] = 1000;
		}
		
		var getPlayerEloInGame = function(playerName, game, gameNum) {

			var oldElo = players[playerName],
				myTeamScore,
				opTeamScore,
				myTeamElo,
				opTeamElo,
				isWin,
				date = new Date(game.date.split('.').reverse().join('-')).getTime(),
				teamDiff,
				bonus;

			if (typeof players[playerName] === "undefined") {
				alert('Unknow player ' + playerName);
			}

			if (isRedTeamPlayer(game, playerName)) {
				myTeamScore = game.redScore;
				opTeamScore = game.blueScore;
				myTeamElo = calculateTeamTotalElo(game.red);
				opTeamElo = calculateTeamTotalElo(game.blue);
			} else {
				myTeamScore = game.blueScore;
				opTeamScore = game.redScore;
				myTeamElo = calculateTeamTotalElo(game.blue);
				opTeamElo = calculateTeamTotalElo(game.red);
			}

			isWin = myTeamScore > opTeamScore;
			
			if (typeof playerMapStats[playerName].played[game.map] === 'undefined') {
				playerMapStats[playerName].played[game.map] = 0;
				playerMapStats[playerName].wins[game.map] = 0;
			}
			
			playerMapStats[playerName].played[game.map] += 1;	
			playerMapStats[playerName].wins[game.map] += isWin ? 1 : -1;

			++playedGames[playerName];
			
			teamDiff = Math.max(myTeamElo, opTeamElo) / Math.min(myTeamElo, opTeamElo);
			teamDiff = teamDiff * 100 - 100;
			teamDiff = teamDiff < 1 ? 1 : teamDiff;
			teamDiff = isWin && myTeamElo > opTeamElo ? 1 : teamDiff;
			teamDiff = !isWin && opTeamElo > myTeamElo ? 1 : teamDiff;
		
			bonus = (isWin ? 1 : -1) * teamDiff * 2;
			
			if (isWin && bonus > 4 && date >= minDarkHorseTs) {
				darkHorses[playerName] ++;
			}
			
			if (isRedTeamPlayer(game, playerName)) {
				if (game.redScore > game.blueScore) {
					++winRates[playerName].wins;
				} else {
					++winRates[playerName].loses;
				}
			} else {
				if (game.blueScore > game.redScore) {
					++winRates[playerName].wins;
				} else {
					++winRates[playerName].loses;
				}
			}
			
			// Apply fixes to the player score
			if (typeof game.fixes !== 'undefined') {
				for (var f in game.fixes) {
					if (game.fixes[f][0] === playerName) {
						bonus += game.fixes[f][1];
					}
				}
			}
			
			return oldElo + bonus;
		};
		
		var updateTeamsEloInGame = function(gameNum) {

			var game = games[gameNum],
				playersInGame = game.red.concat(game.blue),
				eloResults = [];

			for (var i in playersInGame) {
				eloResults[playersInGame[i]] = getPlayerEloInGame(playersInGame[i], game, gameNum);
			}

			for (var playerName in eloResults) {
				players[playerName] = eloResults[playerName];
			}
		};
		
		var getPlayerScore = function (game, playerName) {
			
			var myTeamScore,
				opTeamScore,
				myTeamElo,
				opTeamElo,
				isWin,
				bonus;

			if (isRedTeamPlayer(game, playerName)) {
				myTeamScore = game.redScore;
				opTeamScore = game.blueScore;
				myTeamElo = calculateTeamTotalElo(game.red);
				opTeamElo = calculateTeamTotalElo(game.blue);
			} else {
				myTeamScore = game.blueScore;
				opTeamScore = game.redScore;
				myTeamElo = calculateTeamTotalElo(game.blue);
				opTeamElo = calculateTeamTotalElo(game.red);
			}

			var teamDiff = opTeamElo - myTeamElo,
				isWin = myTeamScore > opTeamScore;
			
			if (isWin) {
				if (teamDiff < 1) {
					bonus = 1;
				} else {
					bonus = 1 + (teamDiff * teamDiff) / (10 * Math.max(myTeamElo, opTeamElo));
				}
			} else {
				bonus = 0;
			}
					
			return bonus;
		};
		
		var updatePlayersScores = function (game, players) {
		
			var playersInGame = game.red.concat(game.blue);
		
			for (var i in playersInGame) {
				scores[playersInGame[i]] += getPlayerScore(game, playersInGame[i]);
			}
		};

		for (i in games) {
			updateTeamsEloInGame(i);
			updatePlayersScores(games[i], players);
		}

		var sortedPlayers = getSortedKeys(players);

		for (i in winRates) {
			winRates[i].avg = Math.ceil((winRates[i].wins / (winRates[i].wins + winRates[i].loses)) * 100);
		}

		var facts = {},
			redWins = 0,
			blueWins = 0,
			lastMap;
		
		// calculate red/blue %
		for (i in games) {
			if (games[i].redScore > games[i].blueScore) {
				++ redWins;
			} else {
				++ blueWins;
			}
		}

		// calculate win/lose streak
		var winningStreak = [],
			losingStreak = [],
			j;
		
		for (i in players) {
			winningStreak[i] = { current: 0, max: 0 };
			losingStreak[i] = { current: 0, max: 0 };
		}
		
		for (i in games) {
			
			var gamePlayers = games[i].red.concat(games[i].blue);
			
			for (j in gamePlayers) {
				
				var playerName = gamePlayers[j],
					redWin = games[i].redScore > games[i].blueScore,
					isRedPlayer = games[i].red.includes(playerName);
				
				if ((redWin && isRedPlayer) || (!redWin && !isRedPlayer)) {
					
					if (++winningStreak[playerName].current > winningStreak[playerName].max) {
						winningStreak[playerName].max = winningStreak[playerName].current;
					}
					
					losingStreak[playerName].current = 0;
					
				} else {
					
					if (++losingStreak[playerName].current > losingStreak[playerName].max) {
						losingStreak[playerName].max = losingStreak[playerName].current;
					}
					
					winningStreak[playerName].current = 0;
				}
			}
			
			lastMap = games[i];
		}
		
		var bestWinningStreak = 0,
			bestWinningStreakPlayer;
		
		for (i in winningStreak) {
			if (winningStreak[i].max > bestWinningStreak) {
				bestWinningStreak = winningStreak[i].max;
				bestWinningStreakPlayer = i;
			}
		}
		
		var worstLosingStreak = 0,
			worstLosingStreakPlayer;
		
		for (i in losingStreak) {
			if (losingStreak[i].max > worstLosingStreak) {
				worstLosingStreak = losingStreak[i].max;
				worstLosingStreakPlayer = i;
			}
		}
			
		facts.redWinRate = (redWins / (blueWins + redWins)) * 100;
		
		var darkHorseValue = 0,
			darkHorsePlayer;
			
		for (i in darkHorses) {
			
			var current = playedGames[i] > 0 ? darkHorses[i] / playedGames[i] : 0;
			
			if (current > darkHorseValue) {
				darkHorsePlayer = i;
				darkHorseValue = current;
			}
		}
		
		var bestMaps = [],
			worstMaps = [],
			mapsStats = [];
			
		for (playerName in playerMapStats) {
		
			var totalPlayed = 0;
		
			for (mapName in playerMapStats[playerName].played) {
				totalPlayed += playerMapStats[playerName].played[mapName];
			}
				
			mapsStats[playerName] = [];
			
			for (mapName in playerMapStats[playerName].wins) {		
				if (playerMapStats[playerName].played[mapName] >= Math.max(2, totalPlayed * 0.05)) {
					mapsStats[playerName][mapName] = playerMapStats[playerName].wins[mapName] / playerMapStats[playerName].played[mapName];
				}
			}
		}
		
		for (playerName in mapsStats) {

			var keys = getSortedKeys(mapsStats[playerName]);	

			if (keys[0] !== keys[keys.length - 1]) {
				bestMaps[playerName] = keys[0];
				worstMaps[playerName] = keys[keys.length - 1];
			}
		}
		
		var maxRating = getMaxInArray(players),
			maxScore = getMaxInArray(scores),
			maxWins = getMaxInArray(winRates, 'wins');

		// calculate active players
		var activePlayersDates = [];
		
		for (i in games) {
		
			var gamePlayers = games[i].red.concat(games[i].blue);
			
			for (j in gamePlayers) {
				
				var playerName = gamePlayers[j];
				
				if (typeof activePlayersDates[playerName] === 'undefined') {
					activePlayersDates[playerName] = 0;
				}
				
				activePlayersDates[playerName] = games[i].date;
			}
		}
		
		var activePlayers = [],
			minActivePlayersDays = 60,
			minActivePlayersTs = Math.ceil((new Date().getTime()) - minActivePlayersDays * 60 * 60 * 24 * 1000);
		
		for (i in activePlayersDates) {
			
			var apdate = new Date(activePlayersDates[i].split('.').reverse().join('-')).getTime();
			
			if (apdate > minActivePlayersTs) {
				activePlayers.push(i);
			}
		}
		
		buff = '';

		buff += '<p><label for="showActiveOnly" style="cursor:pointer;"><input type="checkbox" id="showActiveOnly" checked="checked" /> Show active players only (who have played in the last ' + minActivePlayersDays + ' days).</label></p>';
		
		buff += '<table id="ranksTable" class="tablesorter" style="max-width: 1000px;">'
		+ '<thead><tr>'
		+ '<th>Rank</th>'
		+ '<th>Name</th>'
		+ '<th>Rating</th>'
		+ '<th>Score</th>'
		+ '<th>Wins</th>'
		+ '<th>Loses</th>'
		+ '<th>Wins</th>'
		+ '<th>Best map</th>'
		+ '<th>Worst map</th>'
		+ '</tr></thead><tbody>';

		var line = 1;
		
		for (i in sortedPlayers) {
		
			var playerName = sortedPlayers[i];
		
			buff += '<tr' + (activePlayers.includes(playerName) ? '' : ' style="display:none;" class="inactive"') + '>';
			buff += '<td>' + line + '</td>';
			buff += '<td>' + playerName + '</td>';
			buff += '<td' + (maxRating === players[playerName] ? ' style="background-color: #65f1ff;"' : '') + '><strong>' + Math.ceil(players[playerName]) + '</strong></td>';
			buff += '<td' + (maxScore === scores[playerName] ? ' style="background-color: #ffe377;"' : '') + '>' + Math.ceil(scores[playerName]) + '</td>';
			buff += '<td' + (maxWins === winRates[playerName].wins ? ' style="background-color: #ffe377;"' : '') + '>' + winRates[playerName].wins + '</td>';
			buff += '<td>' + winRates[playerName].loses + '</td>';
			buff += '<td>' + winRates[playerName].avg + '%</td>';
			buff += '<td>' + (typeof bestMaps[playerName] === 'undefined' || bestMaps[playerName] === null ? '?' : bestMaps[playerName]) + '</td>';
			buff += '<td>' + (typeof worstMaps[playerName] === 'undefined' || worstMaps[playerName] === null ? '?' : worstMaps[playerName]) + '</td>';
			buff += '</tr>';
			
			if (activePlayers.includes(playerName)) {
				line++;
			}
		}
		
		buff += '</tbody></table>';
		
		buff += '<br /><i>Last update: ' + lastMap.date + '</i><br /><br />';
		
		buff += '<br /><h4>Facts</h4>';
		buff += '<p>Overall matches played: <b>' + games.length + '</b></p>';
		buff += '<p>Overall, Red - Blue win-rate is <b>' + Math.ceil(facts.redWinRate) + '% - ' + (100 - Math.ceil(facts.redWinRate)) + '%</b></p>';
		buff += '<p>Best winning streak has player <b>' + bestWinningStreakPlayer + '</b> (' + bestWinningStreak + ')</p>';
		buff += '<p>Worst losing streak has player <b>' + worstLosingStreakPlayer + '</b> (' + worstLosingStreak + ')</p>';
		buff += '<p>Dark horse: <b>' + (typeof darkHorsePlayer === 'undefined' ? 'nobody atm' : darkHorsePlayer) + '</b></p>';
		
		buff += '<br /><h4>Rank/ratings calculation rules:</h4>';
		buff += 'Player new rating = [Player old rating] + W * K<br />'
		+ 'W = 1 (if player won the map) or -1 (if player lose the map)<br />'
		+ 'K = floating coefficient depending on the difference in team ratings: higher rating of your team than the opponent team -> lower the coefficient; Lower rating of your team -> higher the coefficient.<br /><br />';
		
		buff += '<br /><h4>Scores calculation rules:</h4>';
		buff += '- Each player starts with the same score (1000).<br />';
		buff += '- If a player wins the match, it gets X points, depending on the difference between the elo-ranks of both teams in the match.<br />';
		buff += '- If a player loses the match, it remains with the same score as before.<br />';
		
		var mapsGames = [];
		
		for (i in games) {
		
			if (typeof mapsGames[games[i].map] === 'undefined') {
				mapsGames[games[i].map] = 0;
			}
			
			++mapsGames[games[i].map];
		}
		
		var sortedMapsGames = getSortedKeys(mapsGames);
		
		buff += '<br /><h4>Maps</h4>';
		
		buff += '<table style="border: #ccc solid 1px; border-collapse: collapse;">'
		+ '<tbody><tr>'
		+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Name</th>'
		+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Games</th>'
		+ '</tr></tbody>';
		
		for (i in sortedMapsGames) {
			buff += '<tr>';
			buff += '<td style="border: #ccc solid 1px; padding: 5px 10px; text-align: right;">' + sortedMapsGames[i] + '</td>';
			buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + mapsGames[sortedMapsGames[i]] + '</td>';
			buff += '</tr>';
		}
		
		buff += '</table><br /><br />';
		
		// teams info
		
		var findGames = function () {
		
			var teams = [];
		
			for (var t=0; t<2; t++) {

				teams[t] = [];

				for (var p=0; p<5; p++) {
			
					var v = document.getElementsByClassName('player-' + t + '-' + p)[0].value.trim();
				
					if(v.length) {
						teams[t].push(v);
					}				
				}
			}
			
			var matchedGames = [],
				matchesWins = 0,
				totalElo = [];
			
			for (var i in games) {
				
				var game = games[i],
					match = true;
				
				for (var t=0; t<2; t++) {
					for (var p in teams[t]) {
						if (t === 0) {
							if (!isRedTeamPlayer(game, teams[t][p])) {
								match = false;
							}
						} else if (!isBlueTeamPlayer(game, teams[t][p])) {
							match = false;
						}
					}
				}
				
				if (match) {
				
					matchedGames.push(game);
					
					if (game.redScore > game.blueScore) {
						matchesWins ++;
					}
					
					continue;
				}
				
				var match2 = true;
				
				for (var t=0; t<2; t++) {
					for (var p in teams[t]) {
						if (t === 0) {
							if (!isBlueTeamPlayer(game, teams[t][p])) {
								match2 = false;
							}
						} else if (!isRedTeamPlayer(game, teams[t][p])) {
							match2 = false;
						}
					}
				}
				
				if (match2) {
				
					matchedGames.push(game);
					
					if (game.blueScore > game.redScore) {
						matchesWins ++;
					}
				}
			}
			
			for (var t=0; t<2; t++) {
			
				totalElo[t] = 0;
			
				for (var p in teams[t]) {
					totalElo[t] += players[teams[t][p]];
				}
			}
			
			var txt = '';
			
			txt += '<br /><br />Found ' + matchedGames.length + ' games.<br />';
			
			if (matchesWins > 0) {
				txt += 'Team #1 won ' + matchesWins + ' of ' + matchedGames.length + ' games agains Team #2 in these games.<br />';
			}
			
			txt += 'Team #1 ELO: ' +  Math.ceil(totalElo[0]) + '<br />Team #2 ELO: ' +  Math.ceil(totalElo[1]) + '<br />';
			txt += '<br />';
					
			for (var g in matchedGames) {
				var game = matchedGames[g];
				txt += '<div>[' + game.date + '] <strong>' + game.map + '</strong> ' + game.redScore + ':' + game.blueScore + '</div>';
				txt += '<div style="font-style: italic; font-size: 14px;">'
				for (var p in game.red) {
					txt += ' <span style="color: red;">' + game.red[p] + '</span> ';
				}
				txt += ' vs ';
				for (var p in game.red) {
					txt += ' <span style="color: blue;">' + game.blue[p] + '</span> ';
				}
				txt += '</div><br />';
			}
			
			document.getElementById('findGamesResult').innerHTML = txt;
		};
		
		var getSelect = function (t, p) {
		
			var txt = '<select class="player-' + t + '-' + p + '">';
			
			txt += '<option value="">- Any -</option>';
			
			for (var p in players) {
				txt += '<option value="' + p + '">' + p + '</option>';
			}
			
			txt += '</select>';
			
			return txt;
		};
		
		buff += '<h4>Analytics</h4>';
		
		for (var t=0; t<2; t++) {
		
			buff += '<p>Team #' + (t + 1) + '</p>';
		
			for (var p=0; p<5; p++) {
				buff += getSelect(t, p) + '&nbsp;';
			}
			
			buff += '<br />';
		}
		
		buff += '<br /><input type="button" value="Find games" onclick="findGames();" />';
		buff += '<br /><div id="findGamesResult"></div>';
		
		buff += '<br /><br /><br />';
		
		data.innerHTML = buff;	
		
		jQuery('#ranksTable').tablesorter({
			theme: 'blue'
		});
		
		$('#showActiveOnly').on('change', function(event) {
		
			if (event.target.checked) {
				$('#ranksTable tr.inactive').hide();
			} else {
				$('#ranksTable tr').show();
			}
			
			var line = 1;
		
			$('#ranksTable tr td:first-child').each(function() {
				
				if (event.target.checked && $(this).parent().hasClass('inactive')) {
					return;
				}
				
				$(this).html(line++);
			});
		});
	
	}, 500);

</script>

</body>
</html>